<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MitigasiHub</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f4f6f9;}
header{background:#0b5ed7;color:white;padding:15px;text-align:center;}
.container{padding:15px;}
.card{background:white;padding:15px;border-radius:10px;margin-bottom:15px;box-shadow:0 4px 10px rgba(0,0,0,0.1);}
input,select{padding:8px;width:100%;margin-bottom:10px;}
button{padding:10px 15px;background:#0b5ed7;color:white;border:none;cursor:pointer;}
button:hover{background:#084298;}
#map{height:350px;border-radius:10px;}
.hidden{display:none;}
table{width:100%;border-collapse:collapse;}
th,td{border:1px solid #ddd;padding:8px;text-align:center;}
th{background:#0b5ed7;color:white;}
.low{background:#d4edda;}
.medium{background:#fff3cd;}
.high{background:#f8d7da;}
.critical{background:#721c24;color:white;}
</style>
</head>
<body>

<header>
<h2>MITIGASIHUB AI – Admin Dashboard</h2>
</header>

<div class="container">

<!-- LOGIN -->
<div id="loginPage" class="card">
<h3>Login Admin</h3>
<input type="text" id="username" placeholder="Username">
<input type="password" id="password" placeholder="Password">
<button onclick="login()">Login</button>
<p id="loginError" style="color:red;"></p>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden">

<div class="card">
<button onclick="logout()">Logout</button>
</div>

<div class="card">
<h3>Input Parameter Risiko</h3>
<input type="text" id="locationInput" placeholder="Contoh: Jakarta Timur">

<select id="rainfall">
<option value="1">Hujan Rendah</option>
<option value="2">Hujan Sedang</option>
<option value="3">Hujan Tinggi</option>
</select>

<select id="elevation">
<option value="3">Elevasi Tinggi</option>
<option value="2">Elevasi Sedang</option>
<option value="1">Elevasi Rendah</option>
</select>

<select id="drainage">
<option value="1">Drainase Baik</option>
<option value="2">Drainase Sedang</option>
<option value="3">Drainase Buruk</option>
</select>

<button onclick="analyzeRisk()">Analisis</button>
<button onclick="exportPDF()">Export PDF</button>
</div>

<div class="card">
<div id="riskResult">Belum dianalisis</div>
<canvas id="riskChart"></canvas>
</div>

<div class="card">
<div id="map"></div>
</div>

<div class="card">
<h3>Database Lokal (Riwayat Analisis)</h3>
<table>
<thead>
<tr>
<th>Lokasi</th>
<th>Skor</th>
<th>Kategori</th>
<th>Tanggal</th>
</tr>
</thead>
<tbody id="historyTable"></tbody>
</table>
</div>

</div>
</div>

<script>

// ===== LOGIN SYSTEM =====
const ADMIN_USER="admin";
const ADMIN_PASS="12345";

function login(){
let u=document.getElementById("username").value;
let p=document.getElementById("password").value;

if(u===ADMIN_USER && p===ADMIN_PASS){
localStorage.setItem("mitigasiLogin","true");
document.getElementById("loginPage").classList.add("hidden");
document.getElementById("dashboard").classList.remove("hidden");
loadHistory();
}else{
document.getElementById("loginError").innerText="Login gagal!";
}
}

function logout(){
localStorage.removeItem("mitigasiLogin");
location.reload();
}

if(localStorage.getItem("mitigasiLogin")==="true"){
document.getElementById("loginPage").classList.add("hidden");
document.getElementById("dashboard").classList.remove("hidden");
}

// ===== MAP =====
let map = L.map('map').setView([-6.2,106.8],11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
attribution:'© OpenStreetMap'
}).addTo(map);
let marker;
let chart;

// ===== ANALYSIS =====
function analyzeRisk(){

let rainfall=parseInt(rainfall.value);
let elevation=parseInt(elevation.value);
let drainage=parseInt(drainage.value);
let location=document.getElementById("locationInput").value;

let score=rainfall+(4-elevation)+drainage;

let category="";
if(score<=4)category="LOW";
else if(score<=6)category="MEDIUM";
else if(score<=8)category="HIGH";
else category="CRITICAL";

document.getElementById("riskResult").innerHTML=
"<b>Risiko:</b> "+category+" (Skor "+score+")";

if(chart)chart.destroy();
chart=new Chart(document.getElementById("riskChart"),{
type:'bar',
data:{labels:["Hujan","Elevasi","Drainase"],
datasets:[{label:"Parameter",data:[rainfall,4-elevation,drainage]}]}
});

// SIMPAN DATABASE LOKAL
let history=JSON.parse(localStorage.getItem("mitigasiData"))||[];
history.push({
lokasi:location,
skor:score,
kategori:category,
tanggal:new Date().toLocaleString()
});
localStorage.setItem("mitigasiData",JSON.stringify(history));
loadHistory();

// MAP SEARCH
fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${location}`)
.then(res=>res.json())
.then(data=>{
if(data.length>0){
let lat=parseFloat(data[0].lat);
let lon=parseFloat(data[0].lon);
map.setView([lat,lon],13);
if(marker)map.removeLayer(marker);
marker=L.marker([lat,lon]).addTo(map)
.bindPopup("Risiko: "+category).openPopup();
}
});
}

// ===== LOAD HISTORY =====
function loadHistory(){
let history=JSON.parse(localStorage.getItem("mitigasiData"))||[];
let table=document.getElementById("historyTable");
table.innerHTML="";
history.forEach(d=>{
table.innerHTML+=`
<tr>
<td>${d.lokasi}</td>
<td>${d.skor}</td>
<td>${d.kategori}</td>
<td>${d.tanggal}</td>
</tr>`;
});
}

// ===== EXPORT PDF =====
async function exportPDF(){
const { jsPDF } = window.jspdf;
let doc=new jsPDF();
doc.text("MitigasiHub AI Report",20,20);
doc.text(document.getElementById("riskResult").innerText,20,40);

let img=document.getElementById("riskChart").toDataURL("image/png");
doc.addImage(img,'PNG',20,50,160,90);
doc.save("MitigasiHub_Admin_Report.pdf");
}

</script>
</body>
</html>
